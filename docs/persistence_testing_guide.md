# A2A Rust æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•æŒ‡å—ä¸æ–°åŠŸèƒ½è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•è¿è¡Œå’ŒéªŒè¯ a2a-rust é¡¹ç›®ä¸­æ–°å¢çš„ SQLite æŒä¹…åŒ–åŠŸèƒ½ï¼Œå¹¶å¯¹è¿‘æœŸå®ç°çš„æ–°åŠŸèƒ½è¿›è¡Œäº†æ¦‚è§ˆã€‚

## ğŸš€ æ–°åŠŸèƒ½è¯´æ˜ (New Features)

### 1. SQLite ä»»åŠ¡æŒä¹…åŒ– (Task Persistence)
`SqlTaskStore` ä¸º A2A ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†æä¾›äº†ç”Ÿäº§çº§çš„æŒä¹…åŒ–å±‚ã€‚
- **çŠ¶æ€ç®¡ç†**ï¼šè‡ªåŠ¨è·Ÿè¸ªä»»åŠ¡çŠ¶æ€è½¬æ¢ï¼ˆå¦‚ `Created` -> `Running` -> `Completed`ï¼‰ã€‚
- **å†å²è®°å½•**ï¼šä»»åŠ¡çš„æ¯ä¸€æ¬¡æ›´æ–°éƒ½ä¼šè®°å½•åœ¨å†å²è¡¨ä¸­ï¼Œç¡®ä¿å¯è¿½æº¯æ€§ã€‚
- **å¹¶å‘æ”¯æŒ**ï¼šåŸºäº `sqlx` å®ç°ï¼Œæ”¯æŒå¯¹ SQLite æ•°æ®åº“çš„å®‰å…¨å¹¶å‘è®¿é—®ã€‚

### 2. åŠ å¯†çš„æ¨é€é…ç½®å­˜å‚¨ (Encrypted Push Config)
`SqlPushNotificationConfigStore` ç¡®ä¿å®¢æˆ·ç«¯æ•æ„Ÿä¿¡æ¯ä¸ä¼šä»¥æ˜æ–‡å½¢å¼å­˜å‚¨ã€‚
- **AES-GCM åŠ å¯†**ï¼šä½¿ç”¨è¡Œä¸šæ ‡å‡†åŠ å¯†ç®—æ³•å­˜å‚¨æ¨é€ Token å’Œé…ç½®ã€‚
- **å®‰å…¨é›†æˆ**ï¼šä¸ç³»ç»Ÿçš„å‡­æ®ç®¡ç†é›†æˆï¼Œå®‰å…¨è·å–åŠ å¯†å¯†é’¥ã€‚

### 3. å¤šæ–¹æ¡ˆè®¤è¯æ‹¦æˆªå™¨ (Auth Interceptor)
`AuthInterceptor` ä½¿ Rust å®¢æˆ·ç«¯çš„å®‰å…¨èƒ½åŠ›ä¸ Python ç‰ˆæœ¬å®Œå…¨å¯¹é½ã€‚
- **åè®®å¯¹é½**ï¼šé€»è¾‘ä¸ Python å®ç° 100% å…¼å®¹ã€‚
- **çµæ´»æ–¹æ¡ˆ**ï¼šæ”¯æŒ Bearer Token, API Key, OAuth2 å’Œ OpenID Connectã€‚
- **è‡ªåŠ¨å¡«å……**ï¼šæ ¹æ®æœåŠ¡å™¨çš„å®‰å…¨è¦æ±‚ï¼Œè‡ªåŠ¨é€‰æ‹©å¹¶åº”ç”¨æ­£ç¡®çš„å‡­æ®ã€‚

### 4. æ¨é€é€šçŸ¥å‘é€å™¨ (Push Notification Sender)
å®ç°äº†ä¸ Python ç‰ˆæœ¬å¯¹é½çš„æ¨é€é€šçŸ¥å‘é€é€»è¾‘ã€‚
- **å¼‚æ­¥å‘é€**ï¼šåŸºäº `reqwest` å®ç°ï¼Œæ”¯æŒå¹¶å‘å‘å¤šä¸ªç›®æ ‡å‘é€é€šçŸ¥ã€‚
- **Token è®¤è¯**ï¼šæ”¯æŒ `X-A2A-Notification-Token` è¯·æ±‚å¤´ï¼Œç¡®ä¿æ¨é€å®‰å…¨æ€§ã€‚
- **é«˜åº¦å¯¹é½**ï¼šæ•°æ®ç»“æ„å’Œå‘é€æµç¨‹ä¸ Python ç‰ˆæœ¬çš„ `BasePushNotificationSender` ä¿æŒä¸€è‡´ã€‚

### 5. é»˜è®¤è¯·æ±‚å¤„ç†å™¨ (Default Request Handler)
å®ç°äº†ä¸ Python ç‰ˆæœ¬æ¶æ„å®Œå…¨ä¸€è‡´çš„ `DefaultRequestHandler`ã€‚
- **è‡ªåŠ¨æ¨é€**ï¼šåœ¨ `on_message_send` å’Œ `on_message_send_stream` ä¸­è‡ªåŠ¨è§¦å‘æ¨é€é€šçŸ¥ã€‚
- **é…ç½®é›†æˆ**ï¼šè‡ªåŠ¨ä»è¯·æ±‚å‚æ•°ä¸­æå–å¹¶ä¿å­˜æ¨é€é…ç½®ã€‚
- **çŠ¶æ€åŒæ­¥**ï¼šç¡®ä¿ä»»åŠ¡çŠ¶æ€å˜æ›´ï¼ˆå¦‚å–æ¶ˆä»»åŠ¡ï¼‰æ—¶èƒ½åŠæ—¶é€šçŸ¥å®¢æˆ·ç«¯ã€‚

---

## ğŸ“– ç¤ºä¾‹ç¨‹åº (Examples)

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ç¨‹åºï¼Œæ¼”ç¤ºäº†å¦‚ä½•åˆå§‹åŒ–æ•°æ®åº“å¹¶ä½¿ç”¨ `TaskManager` è¿›è¡Œä»»åŠ¡æŒä¹…åŒ–ã€‚

### è¿è¡Œç¤ºä¾‹
```bash
cargo run --example sqlite_persistence_demo
```

### ç¤ºä¾‹æ¶µç›–å†…å®¹ï¼š
1. **æ•°æ®åº“è¿æ¥**ï¼šæ¼”ç¤ºå¦‚ä½•è¿æ¥åˆ° SQLiteï¼ˆç¤ºä¾‹ä¸­ä½¿ç”¨ `:memory:` æ¨¡å¼ï¼‰ã€‚
2. **è¡¨ç»“æ„åˆå§‹åŒ–**ï¼šè‡ªåŠ¨åˆ›å»º `tasks` è¡¨ã€‚
3. **ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ**ï¼š
   - åˆ›å»ºæ–°ä»»åŠ¡ã€‚
   - é€šè¿‡ `TaskManager` æ›´æ–°ä»»åŠ¡çš„æ¶ˆæ¯å†å²ã€‚
   - å°†ä»»åŠ¡æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚
   - ä»æ•°æ®åº“æŒ‰ ID æ£€ç´¢ä»»åŠ¡å¹¶éªŒè¯çŠ¶æ€ã€‚
   - åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚

---

## ğŸ§ª é›†æˆæµ‹è¯• (Integration Tests)

æ–°å¢çš„é›†æˆæµ‹è¯•æ–‡ä»¶ `tests/persistence_integration_test.rs` è¦†ç›–äº†æ›´å¤æ‚çš„æŒä¹…åŒ–åœºæ™¯ã€‚

### è¿è¡Œé›†æˆæµ‹è¯•
```bash
cargo test --test persistence_integration_test
```

### æµ‹è¯•ç”¨ä¾‹è¯´æ˜ï¼š
- **`test_full_persistence_lifecycle`**: éªŒè¯å¤šä»»åŠ¡å¹¶å‘ä¿å­˜ã€è¯»å–ã€çŠ¶æ€æ›´æ–°ä»¥åŠåˆ é™¤æ“ä½œçš„æ­£ç¡®æ€§ã€‚
- **`test_encrypted_push_config_persistence`**: éªŒè¯æ¨é€é€šçŸ¥é…ç½®çš„**åŠ å¯†å­˜å‚¨**ã€‚å®ƒä¼šæ£€æŸ¥æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ Tokenï¼‰æ˜¯å¦èƒ½è¢«æ­£ç¡®åŠ å¯†å†™å…¥å¹¶è§£å¯†è¯»å‡ºã€‚

---

## å•å…ƒæµ‹è¯• (Unit Tests)

æ‚¨ä¹Ÿå¯ä»¥è¿è¡Œå†…ç½®åœ¨æºç ä¸­çš„ SQL å­˜å‚¨å•å…ƒæµ‹è¯•ï¼š

```bash
# è¿è¡Œä»»åŠ¡å­˜å‚¨å•å…ƒæµ‹è¯•
cargo test sql_task_store

# è¿è¡Œæ¨é€é…ç½®å­˜å‚¨å•å…ƒæµ‹è¯•
cargo test sql_push_notification_config_store
```

---

## ğŸ” è®¤è¯åŠŸèƒ½æµ‹è¯• (Auth Interceptor Testing)

æ–°å¢çš„è®¤è¯æ‹¦æˆªå™¨æµ‹è¯•éªŒè¯äº†å®¢æˆ·ç«¯åœ¨ä¸åŒå®‰å…¨ç­–ç•¥ä¸‹çš„å‡­æ®å¡«å……é€»è¾‘ã€‚

### è¿è¡Œè®¤è¯æµ‹è¯•
```bash
cargo test --test auth_integration_test
```

### æµ‹è¯•ç”¨ä¾‹è¯´æ˜ï¼š
- **`test_auth_interceptor_multi_scheme`**: 
  - æ¨¡æ‹Ÿä¸€ä¸ªè¦æ±‚å¤šç§å®‰å…¨æ–¹æ¡ˆï¼ˆå¦‚ `Bearer` å’Œ `ApiKey`ï¼‰çš„ APIã€‚
  - éªŒè¯æ‹¦æˆªå™¨æ˜¯å¦èƒ½ä»å‡­æ®æœåŠ¡ä¸­æ­£ç¡®æå– Token å¹¶å¡«å……åˆ° HTTP Header ä¸­ã€‚
  - æ£€æŸ¥ `Authorization` å’Œ `X-API-Key` ç­‰å…³é”®å­—æ®µçš„å‡†ç¡®æ€§ã€‚

---

## ğŸ”” æ¨é€åŠŸèƒ½æµ‹è¯• (Push Notification Testing)

éªŒè¯ Rust ç‰ˆæœ¬æ˜¯å¦èƒ½æ­£ç¡®å‘å¤–éƒ¨æœåŠ¡å‘é€ä»»åŠ¡æ›´æ–°é€šçŸ¥ï¼Œä»¥åŠ Handler å±‚æ˜¯å¦å®ç°äº†è‡ªåŠ¨è§¦å‘ã€‚

### è¿è¡Œæ¨é€å•å…ƒæµ‹è¯•
```bash
cargo test push_notification_sender
```

### è¿è¡Œ Handler é›†æˆæµ‹è¯• (è‡ªåŠ¨æ¨é€)
```bash
cargo test --test push_integration_test
```

### æµ‹è¯•ç”¨ä¾‹è¯´æ˜ï¼š
- **`test_http_push_sender_success`**: éªŒè¯å‘é€å™¨ç»„ä»¶çš„åŸºç¡€å‘é€é€»è¾‘ã€‚
- **`test_default_handler_auto_push`**: 
  - æ¨¡æ‹Ÿå®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹ã€‚
  - éªŒè¯ `DefaultRequestHandler` åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæ˜¯å¦èƒ½è‡ªåŠ¨ä¿å­˜é…ç½®å¹¶è§¦å‘æ¨é€ã€‚
  - ç¡®ä¿ Rust ç‰ˆæœ¬çš„è‡ªåŠ¨åŒ–é›†æˆè¡Œä¸ºä¸ Python ç‰ˆæœ¬å®Œå…¨ä¸€è‡´ã€‚

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶
- **ç¤ºä¾‹ä»£ç **: `examples/sqlite_persistence_demo.rs`
- **é›†æˆæµ‹è¯•**: `tests/persistence_integration_test.rs`
- **æ ¸å¿ƒå®ç°**: 
  - `src/a2a/server/tasks/sql_task_store.rs`
  - `src/a2a/server/tasks/sql_push_notification_config_store.rs`
  - `src/a2a/client/auth/interceptor.rs` (è®¤è¯æ‹¦æˆªå™¨)
  - `src/a2a/server/tasks/push_notification_sender.rs` (æ¨é€å‘é€å™¨)
  - `src/a2a/server/request_handlers/default_request_handler.rs` (é»˜è®¤å¤„ç†å™¨)
- **è®¤è¯æµ‹è¯•**:
  - `tests/auth_integration_test.rs`
- **æ¨é€æµ‹è¯•**:
  - `src/a2a/server/tasks/push_notification_sender.rs` (å†…ç½®å•å…ƒæµ‹è¯•)
  - `tests/push_integration_test.rs` (Handler é›†æˆæµ‹è¯•)
